metadata:
    name: lava-android-benchmark-host
    format: "Lava-Test-Shell Test Definition 1.0"
    description: "Multinode host part for android benchmarking"
    maintainer:
        - milosz.wasilewski@linaro.org
    os:
        - android
    scope:
        - performance
    devices:
        - kvm

install:
    git-repos:
        - http://git.linaro.org/git/qa/android-apk-automation.git
        - https://github.com/dtmilano/AndroidViewClient.git
    steps:
        - cd AndroidViewClient/
        - git checkout $AVC_VERSION
        - cd AndroidViewClient/
        - python setup.py install
    deps:
        - git
        - python-pil
        - python-setuptools

params:
    # this corresponds to version 0.7.6 of AVC
    # this is a good known version
    # later versions sometimes fail to press buttons on the UI
    AVC_VERSION: "7fc8b7f8c618ec4a2cca67f46d43b40f4cf02ed5"
    TEST_NAME: "geekbench"
    ITERATIONS: 1

run:
    steps:
        - apt-add-repository -y http://ppa.launchpad.net/nilarimogard/webupd8/ubuntu
        - apt-get update -y
        - apt-get install -y android-tools-adb android-tools-fastboot
        - lava-wait $TEST_NAME-send-ip
        - IPADDR=`awk -F '=' '{print $2}' /tmp/lava_multi_node_cache.txt`
        - adb connect $IPADDR
        - adb wait-for-device
        - cd android-apk-automation/$TEST_NAME
        - for (( LOOP=1; LOOP<=$ITERATIONS; LOOP++ )); do lava-test-case $TEST_NAME-execution-$LOOP --shell ./execute.sh $IPADDR:5555; done;
        - if [ -f logcat_canvas.log ]; then lava-test-run-attach logcat_canvas.log text/plain; fi
        - if [ -f logcat.log ]; then lava-test-run-attach logcat.log text/plain; fi
        - if [ -f logcat_textview.log ]; then lava-test-run-attach logcat_textview.log text/plain; fi
        - if [ -f logcat_webview.log ]; then lava-test-run-attach logcat_webview.log text/plain; fi
        - lava-sync $TEST_NAME-finished
